

[TOC]



# 分库

## 一、基本介绍

### 1、基本概念

分表能够解决单表数据量过大带来的查询效率下降的问题，但是，却无法给数据库的并发处理能力带来质的提升。面对高并发的读写访问，当数据库master服务器无法承载写操作压力时，不管如何扩展slave服务器，此时都没有意义了。因此，我们必须换一种思路，对数据库进行拆分，从而提高数据库写入能力，这就是所谓的分库。



### 2、存在问题

**1）事务问题**

在执行分库分表之后，由于数据存储到了不同的库上，数据库事务管理出现了困难。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价；如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。

**2）跨库跨表的join问题**

在执行了分库分表之后，难以避免会将原本**逻辑关联性很强的数据划分到不同的表、不同的库上**，这时，表的关联操作将受到限制，我们无法join位于不同分库的表，也无法join分表粒度不同的表，结果原本一次查询能够完成的业务，可能需要**多次查询**才能完成。

**3）额外的数据管理负担和数据运算压力**

额外的数据管理负担，最显而易见的就是数据的定位问题和数据的增删改查的重复执行问题，这些都可以通过应用程序解决，但必然引起额外的逻辑运算，例如，对于一个记录用户成绩的用户数据表userTable，业务要求查出成绩最好的100位，在进行分表之前，只需一个order by语句就可以搞定，但是在进行分表之后，将需要n个order by语句，分别查出每一个分表的前100名用户数据，然后再对这些数据进行合并计算，才能得出结果。

### 3、解决方案

使用类似JTA提供的分布式事物机制

对于不同的方式之间没有严格的界限，特点不同，侧重点不同。需要根据实际情况，结合每种方式的特点来进行处理。

选用第三方的数据库中间件（Atlas，Mycat，TDDL，DRDS），同时业务系统需要配合数据存储的升级。

### 4、适用场景

- 单台DB的存储空间不够
- 随着查询量的增加单台数据库服务器已经没办法支撑

### 5、解决问题

为突破单节点数据库服务器的 I/O 能力限制，解决数据库扩展性问题





## 二、分类

### 垂直拆分

将系统中不存在关联关系或者需要join的表可以放在不同的数据库不同的服务器中。

按照业务垂直划分。比如：可以按照业务分为资金、会员、订单三个数据库。

需要解决的问题：跨数据库的事务、jion查询等问题。

### 水平拆分

例如，大部分的站点。数据都是和用户有关，那么可以根据用户，将数据按照用户水平拆分。

按照规则划分，一般水平分库是在垂直分库之后的。比如每天处理的订单数量是海量的，可以按照一定的规则水平划分。需要解决的问题：数据路由、组装。

### 读写分离

对于时效性不高的数据，可以通过读写分离缓解数据库压力。需要解决的问题：在业务上区分哪些业务上是允许一定时间延迟的，以及数据同步问题。







# 分区

## 一、基本介绍

### 1、基本概念

  数据分区是一种物理数据库的设计技术，它的目的是为了在特定的SQL操作中减少数据读写的总量以缩减响应时间。

分区并不是生成新的数据表，而是将表的数据均衡分摊到不同的硬盘，系统或是不同服务器存储介子中，实际上还是一张表。另外，分区可以做到将表的数据均衡到不同的地方，提高数据检索的效率，降低数据库的频繁IO压力值

### 2、优点

- 相对于单个文件系统或是硬盘，分区可以存储更多的数据；

- 数据管理比较方便，比如要清理或废弃某年的数据，就可以直接删除该日期的分区数据即可；
- 精准定位分区查询数据，不需要全表扫描查询，大大提高数据检索效率；
- 可跨多个分区磁盘查询，来提高查询的吞吐量；
- 在涉及聚合函数查询时，可以很容易进行数据的合并；

### 3、适用场景

- 一张表的查询速度已经慢到影响使用的时候。
- 表中的数据是分段的
- 对数据的操作往往只涉及一部分数据，而不是所有的数据

### 4、实例

```sql
CREATE TABLE sales (
    id INT AUTO_INCREMENT,
    amount DOUBLE NOT NULL,
    order_day DATETIME NOT NULL,
    PRIMARY KEY(id, order_day)
) ENGINE=Innodb 
PARTITION BY RANGE(YEAR(order_day)) (
    PARTITION p_2010 VALUES LESS THAN (2010),
    PARTITION p_2011 VALUES LESS THAN (2011),
    PARTITION p_2012 VALUES LESS THAN (2012),
PARTITION p_catchall VALUES LESS THAN MAXVALUE);
```



## 二、分类

## 1、垂直分区

根据数据库里面数据表的相关性进行拆分。即把一张列比较多的表根据列的相关性拆分为多张表。

- 优点：可以使得行数据变小，简化表的结构。

- 缺点：

  - 主键会出现冗余，需要管理冗余列，并会引起 Join 操作（可以通过在应用层进行Join来解决）。

  - 垂直分区会让事务变得更加复杂。

    

## 2、水平分区

保持数据表结构不变，通过某种策略存储数据分片。这样每一片数据分散到不同的表或者库中，达到了分布式的目的。 水平拆分可以支撑非常大的数据量。

- 水平拆分最好分库。水平拆分能够支持非常大的数据量存储，应用端改造也少，但分片事务难以解决 ，跨界点 Join 性能较差，逻辑复杂。
- 尽量不要对数据进行分片，因为拆分会带来逻辑、部署、运维的各种复杂度。







------



# 分表

## 一、基本介绍

### 1、基本概念

**把一张表分成多个小表**





### 3、适用场景

- 一张表的查询速度已经慢到影响使用的时候。
- 当频繁插入或者联合查询时，速度变慢。

分表的实现需要业务结合实现和迁移，较为复杂。



------



# 分表和分区

## 一、基本介绍

分表从表面意思说就是**把一张表分成多个小表**，分区则是把**一张表的数据分成N多个区块**，这些区块可以在同一个磁盘上，也可以在不同的磁盘上



## 二、分表和分区的区别

### 1、实现方式上 

mysql的分表是真正的分表，一张表分成很多表后，**每一个小表都是完正的一张表**，都对应**三个文件**（MyISAM引擎：一个.MYD数据文件，.MYI索引文件，.frm表结构文件）。

### 2、数据处理上 

分表后数据都是存放在分表里，总表只是一个外壳，存取数据发生在一个一个的分表里面。

分区则不存在分表的概念，分区只不过把存放数据的文件分成了许多小块，分区后的表还是一张表，数据处理还是由自己来完成

### 3、提高性能上 

 分表后，**单表的并发能力提高**了，**磁盘I/O性能也提高了**。

分区突破了**磁盘I/O瓶颈**，想**提高磁盘的读写能力**，来增加mysql性能。 

在这一点上，分区和分表的测重点不同，分表重点是存取数据时，如何提高mysql并发能力上；而分区呢，如何突破磁盘的读写能力，从而达到提高mysql性能的目的

### 4、实现的难易度上 

分表的方法有很多，用**merge**来分表，是最简单的一种方式。这种方式和分区难易度差不多，并且对程序代码来说可以做到透明的。如果是用其他分表方式就比分区麻烦了。 分区实现是比较简单的，建立分区表，跟建平常的表没什么区别，并且对代码端来说是透明的







# 参考资料：

​		[1]   https://blog.csdn.net/qq_28289405/article/details/80576614