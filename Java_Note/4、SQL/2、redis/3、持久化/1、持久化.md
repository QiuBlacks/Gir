# 持久化

# 一、基本介绍

### 1、什么是Redis持久化？

持久化就是把内存的数据写到磁盘中去，防止**服务宕机**了内存数据丢失。

RDB做镜像**全量持久化**，AOF做**增量持久化**。因为RDB会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要AOF来配合使用。在redis实例重启时，会使用RDB持久化文件重新构建内存，再使用AOF重放近期的操作指令来实现完整恢复重启之前的状态。



# 二、Redis 的持久化机制

Redis 提供两种持久化机制 **RDB（默认）** 和 AOF 机制

## 1、RDB

RDB：是Redis DataBase缩写 快照

RDB是**Redis默认的持久化方式**。按照一定的时间将内存的数据以**快照**的形式保存到硬盘中，对应产生的数据文件为**dump.rdb**。通过配置文件中的save参数来定义快照的周期。

### 1.1、优点

- 只有一个文件 dump.rdb，方便持久化
- 容灾性好，一个文件可以保存到安全的磁盘
- 性能最大化，fork 子进程来完成写操作，让主进程继续处理命令，所以是 IO 最大化。使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 redis 的高性能
- 恢复比较大的数据集时，比 AOF 的启动恢复效率更高



### 1.2 、缺点：

- 数据安全性低。RDB 是**间隔一段时间进行持久化**，如果持久化之间 redis 发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候)
- RDB 需要经常fork子进程来保存数据集到硬盘上，当数据集比较大的时候，fork的过程是非常耗时的，可能会导致Redis在一些毫秒级内不能响应客户端的请求。如果数据集巨大并且CPU性能不是很好的情况下,这种情况会持续更久。
- AOF（Append-only file)持久化方式： 是指所有的命令行记录以 redis 命令请求协议的格式完全持久化存储)保存为 aof 文件。





## 2、AOF

AOF持久化 (即**Append Only File持久化**)，则是将Redis执行的每次写命令记录到**单独的日志文件**中，当重启Redis会重新将持久化的日志中文件恢复数据。

当两种方式同时开启时，数据恢复Redis会优先选择AOF恢复。

### 2.1优点

- 数据安全，aof 持久化可以配置 appendfsync 属性，有 always，每进行一次 命令操作就记录到 aof 文件中一次。
- 通过 append 模式写文件，即使中途服务器宕机，可以通过 **redis-check-aof 工具解决数据一致性问题。**
- AOF 机制的 rewrite 模式。AOF 文件没被 rewrite 之前（文件过大时会对命令 进行合并重写），可以删除其中的某些命令（比如误操作的 flushall）)

### 2.2 缺点

- AOF 文件比 RDB 文件大，且恢复速度慢。
- 数据集大的时候，比 rdb 启动效率低。



## 3、如何选择合适的持久化方式

- 一般来说， 如果想达到足以媲美PostgreSQL的数据安全性，你应该同时使用两种持久化功能。在这种情况下，当 Redis 重启的时候会优先载入AOF文件来恢复原始的数据，因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整。
- 如果你非常关心你的数据， 但仍然可以承受数分钟以内的数据丢失，那么你可以只使用RDB持久化。
- 有很多用户都只使用AOF持久化，但并不推荐这种方式，因为定时生成RDB快照（snapshot）非常便于进行数据库备份， 并且 RDB 恢复数据集的速度也要比AOF恢复的速度要快，除此之外，使用RDB还可以避免AOF程序的bug。
- 如果你**只希望你的数据在服务器运行的时候存在**，你也可以不使用任何持久化方式。





对于主从同步来说，主从刚刚连接的时候，进行全量同步（RDB）；全同步结束后，进行增量同步(AOF)。











