# 底层实现：B+Tree

MySQL的数据是存储在磁盘文件中的，查询处理数据时，需要先把磁盘中的数据加载到内存中，磁盘IO 操作非常耗时，所以我们优化的重点就是**尽量减少磁盘 IO 操作**。访问二叉树的每个节点就会发生一次IO，如果想要减少磁盘IO操作，就需要**尽量降低树的高度。**



# 一、B+树和hash树

hash索引底层就是hash表,进行查找时，调用一次hash函数就可以获取到相应的键值,之后进行回表查询获得实际数据

B+树底层实现是多路平衡查找树。对于每一次的查询都是从根节点出发,查找到叶子节点方可以获得所查键值,然后根据查询判断是否需要回表查询数据

### 二者优劣

#### 1、范围查询

hash索引进行等值查询更快(一般情况下),但是却**无法进行范围查询**。因为在hash索引中经过hash函数建立索引之后,索引的顺序与原顺序无法保持一致,不能支持范围查询.

而B+树的的所有节点皆遵循(左节点小于父节点,右节点大于父节点,多叉树也类似),天然支持范围.

#### 2、索引排序

hash索引不支持使用索引进行排序，原理同上.

#### 3、模糊查询

hash索引不支持模糊查询以及多列索引的最左前缀匹配.原理也是因为hash函数的不可预测.**AAAA**和**AAAAB**的索引没有相关性.

#### 4、回表查询

hash索引任何时候**都避免不了回表查询数据。**

而B+树在符合某些条件(聚簇索引,覆盖索引等)的时候可以只通过索引完成查询.

#### 5、性能稳定性

hash索引虽然在等值查询上较快,但是不稳定.性能不可预测,当某个键值存在大量重复的时候,发生hash碰撞,此时效率可能极差

而B+树的查询效率比较稳定,对于所有的查询都是从根节点到叶子节点,且树的高度较低.



# 二、数据库为什么使用B+树而不是B树

### 1、B+树更适合基于范围的查询

B树只适合等值查询，而B+树同时支持**等值查询和范围查询；**

如果查询10到35之间的数据时，查找到一个符合的数据后，需要回到根节点重新遍历查找，需要从根节点进行多次遍历，查询效率有待提高。

### 2、B+树的磁盘读写代价更低

B+树**空间利用率更高，可减少I/O次数，磁盘读写代价更低**。

一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。这样的话，索引查找过程中就要产生磁盘I/O消耗。B+树的内部结点并没有指向关键字具体信息的指针，只是作为索引使用，其内部结点比B树小，盘块能容纳的结点中关键字数量更多，一次性读入内存中可以查找的关键字也就越多，相对的，IO读写次数也就降低了。而IO读写次数是影响索引检索效率的最大因素；

### 3、B+树的查询效率更加稳定

B树搜索有可能会在非叶子结点结束，越靠近根节点的记录查找时间越短，只要找到关键字即可确定记录的存在，其性能等价于在关键字全集内做一次二分查找。

而在B+树中，顺序检索比较明显，随机检索时，任何关键字的查找都必须走一条从根节点到叶节点的路，所有关键字的查找路径长度相同，导致每一个关键字的查询效率相当。

### 4、B+树更便于遍历

B-树在提高了磁盘IO性能的同时并没有解决元素遍历的效率低下的问题。B+树的叶子节点使用指针顺序连接在一起，只要遍历叶子节点就可以实现整棵树的遍历。而且在数据库中基于范围的查询是非常频繁的，而B树不支持这样的操作。

### 5、增删文件（节点）时，效率更高。

因为B+树的叶子节点包含所有关键字，并以有序的链表结构存储，这样可很好提高增删效率。





# 三、为什么MySQL数据库要用B+树存储索引？

1、这和业务场景有关。如果只选一个数据，那确实是hash更快。但是数据库中经常会选择多条，这时候由于B+树索引有序，并且又有链表相连，它的查询效率比hash就快很多了。

而且数据库中的索引一般是在磁盘上，数据量大的情况可能无法一次装入内存，B+树的设计可以允许数据分批加载，同时树的高度较低，提高查找效率。

## 1、 B+树的磁盘读写代价更低

数据库文件很大,需要存储到磁盘上,索引的结构组织要尽量**减少查找过程中磁盘 I/O 的存取次数。**

将一个节点的大小设为等于一个页,这样每个节点只需要一次 I/O 就可以完全载 入。

B+树中的每个结点可以包含大量的关键字,这样树的深度降低了,所以任何关键 字的查找必须走一条从根结点到叶子结点的路,所有关键字查询的路径长度相同,导致 每一个数据的查询效率相当, 这就意味着查找一个元素只要很少结点从外存磁盘中读入 内存,很快访问到要查找的数据,减少了磁盘 I/O 的存取次数。



## 2、B+树的查询效率更加稳定

数据库中select数据，不一定只选一条，很多时候会选多条，比如按照id排序后选10条。

如果是多条的话，B树需要做**局部的中序遍历**，可能要跨层访问。而B+树由于所有数据都在叶子结点，不用跨层，同时由于有链表结构，只需要找到首尾，通过链表就能把所有数据取出来了。

**B+树的查询效率更加稳定：由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。**



参考：

[帅地玩编程](https://mp.weixin.qq.com/s?__biz=Mzg2NzA4MTkxNQ==&mid=2247485081&idx=1&sn=4f8bdbe7ef9558b8360bd3caa87a729d&scene=21#wechat_redirect)











