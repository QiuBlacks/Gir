# MySQL主从复制

# 一、基本介绍

## 1、定义

MySQL 主从复制是指数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。

MySQL 默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据

数据的更新可以在远程连接上进行，从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。

主从复制是MySQL最重要的功能之一。对于多级复制，数据库服务器即可充当主机，也可充当从机。MySQL主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新。

## 2、为什么要主从复制

- 随着系统中业务访问量的增大，如果是单机部署数据库，就会导致I/O访问频率过高。有了主从复制，增加多个数据存储节点，将负载分布在多个从节点上，降低单机磁盘I/O访问的频率，提高单个机器的I/O性能；
- 一般会让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作；
- 从库可以实时从主库进行复制，这样就可以做数据的热备；





# 二、原理

## 1、基本原理

Mysql 中有一种日志叫做 **binlog日志（二进制日志**）。这个日志会记录下所有修改了数据库的SQL 语句
		主从复制的原理其实就是把主服务器上的二进制日志复制到从服务器上执行一遍，这样从服务器上的数据就和主服务器上的数据就相同了。

## 2、三个线程

### 2.1 、binary log dump 线程（主节点 ）

负责将主服务器上的数据更改写入二进制日志（`Binary log`）中。

当从节点连接主节点时，主节点会创建一个log dump线程，用于发送bin-log的内容。在读取bin-log中的操作时，此线程会对主节点的bin-log加锁，当读取完成，甚至在发送给从节点之前，锁会被释放。

### 2.2、I/O线程（从节点）：拉取更新

负责从 主服务器 上读取二进制日志，并写入从服务器的**中继日志**（`Relay log`）。

当从节点上执行‘start slave’命令之后，从节点会创建一个I/O线程用来连接主节点，**请求主库中更新的bin-log**。I/O线程接收到主节点binlog dump 进程发来的更新之后，保存在本地relay-log中。 

### 2.3、SQL线程（从节点）：执行

SQL线程负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。



对于每一个主从连接，都需要三个进程来完成。**当主节点有多个从节点时，主节点会为每一个当前连接的从节点建一个binary log dump 进程，而每个从节点都有自己的I/O进程，SQL进程。**

从节点用两个线程将从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能。比如，如果从节点没有运行，此时I/O进程可以很快从主节点获取更新，尽管SQL进程还没有执行。如果在SQL进程执行之前从节点服务停止，至少I/O进程已经从主节点拉取到了最新的变更并且保存在本地relay日志中，当服务再次起来之后，就可以完成数据的同步。

 

## 3、复制过程

要实施复制，首先必须打开Master 端的binary log（bin-log）功能，否则无法实现。

因为整个复制过程实际上就是Slave 从Master 端获取该日志然后再在自己身上完全顺序的执行日志中所记录的各种操作。

- 从节点上的I/O 进程连接主节点，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容；
- 主节点接收到来自从节点的I/O请求后，通过负责复制的I/O进程根据请求信息读取指定日志指定位置之后的日志信息，返回给从节点。返回信息中除了**日志所包含的信息之外，还包括本次返回的信息的bin-log file 的以及bin-log position**；从节点的I/O进程接收到内容后，将接收到的日志内容更新到本机的**relay log**中，并将读取到的binary log文件名和位置保存到master-info 文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从某个bin-log 的哪个位置开始往后的日志内容，请发给我”；
- Slave 的 SQL线程检测到relay-log 中新增加了内容后，会将relay-log的内容解析成在祝节点上实际执行过的操作，**并在本数据库中执行。**





# 三、主从复制形式

## 1、一主一从

## 2、一主多从

## 3、多主一从 （从5.7开始支持）

## 4、双主复制

## 5、级联复制





# 四、主从复制的模式









# 参考文章

[MySQL数据库——主从复制](https://blog.csdn.net/qq_41808387/article/details/107009748)









