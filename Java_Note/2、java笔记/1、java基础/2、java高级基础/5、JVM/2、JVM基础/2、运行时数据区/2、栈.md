# 栈

栈是私有的，操作系统会为每个线程分配属于它自己的内存空间，通常称为栈内存，其它线程无权访问。

如果一些数据只有某个线程会使用，其它线程不能操作也不需要操作，这些数据就可以放入线程的栈内存中	

# 一、虚拟机栈

GC不会涉及虚拟机栈

### 1、分类

分为java虚拟机栈和本地方法栈，这里主要讲虚拟栈

### 2、特点
存放基本数据类型、对象的引用、方法出口等，线程私有。
### 3、虚拟机栈结构
每个线程（方法）执行都会创建一个栈帧(Stack Frame)：用于存放局部变量表，操作栈，动态链接，方法出口
#### 3.1 、局部变量表(Local Variables)

一个数字数组，用于**存放方法参数和方法内部定义的局部变量**。

数字数组中，如果是基本数据类型变量，则存储的是变量值，如果是引用数据类型，则存储的是堆内对象的地址值。

#### 3.2 操作数栈

用于保存计算过程中的中间结果，同时作为变量计算过程中的临时存储空间（可能存在逃逸分析）

方法的执行操作在操作数栈中完成，每一个字节码指令往操作数栈进行写入和提取的过程，就是入栈和出栈的过程

#### 3.3 动态链接

在Java源文件被编译到字节码文件时，所有的变量和方法引用都作为符号引用保存在字节码文件的常量池中，动态链接的作用就是转换为调用方法的直接引用（**记录在方法区的运行时常量池中的方法的地址**）。

（每个栈帧都包含一个指向**运行时常量池（JVM 运行时数据区域）**中该栈帧所属方法的**引用**，持有这个引用是为了支持方法调用过程中的动态连接）

在类加载阶段中的解析阶段会将符号引用转为直接引用，这种转化也称为静态解析。

另外的一部分将在每一次运行时期转化为直接引用。这部分称为动态连接



#### 3.4 方法出口

当一个方法执行完毕之后，要返回之前调用它的地方，因此在栈帧中必须保存一个方法返回地址

正常完成出口:执行引擎遇到任何一个方法返回的字节码指令时，会有返回值传递给上层的方法调用者。

异常完成出口：在方法的执行过程中遇到了异常，且没有在本方法内部进行处理，就会退出。

![image-20200612094815979](https://gitee.com/BlacksJack/picture-bed/raw/master/img/20200910165409.png)



### 4、Java虚拟机栈这个区域，Java虚拟机规范规定了两种异常：

- 如果线程请求分配的栈容量超过了 Java 虚拟机栈允许的最大容量，Java 虚拟机将会抛出 **StackOverflowError** 异常。

- 如果 Java 虚拟机栈可以动态扩展，并且在尝试扩展的时候无法申请到足够的内存，或者在创建新的线程时没有足够的内存去创建对应的虚拟机栈，那 Java 虚拟机将抛出一个 **OutOfMemoryError** 异常。

  

# 二、重要知识点

### 1、虚拟机栈和本地方法栈为什么是私有的?

- **虚拟机栈：** 每个 Java 方法在执行的同时会创建一个栈帧用于存储局部变量表、操作数栈、常量池引用等信息。从方法调用直至执行完成的过程，就对应着一个栈帧在 Java 虚拟机栈中入栈和出栈的过程。
- **本地方法栈**： 和虚拟机栈所发挥的作用非常相似，区别是： 虚拟机栈为**虚拟机执行 Java 方法** （也就是字节码）服务，而本地方法栈则为**虚拟机使用到的 Native 方法**服务。 在 HotSpot 虚拟机中和 Java 虚拟机栈合二为一。

所以，为了**保证线程中的局部变量不被别的线程访问到**，虚拟机栈和本地方法栈是线程私有的。



2、







## 参考文章

[JVM 系列 - 内存区域 - Java 虚拟机栈（三)](https://www.jianshu.com/p/ecfcc9fb1de7)

[Java虚拟机栈](https://www.cnblogs.com/old-cha/p/13089555.html)







