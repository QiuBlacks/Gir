# 一、基础知识

## 1、基本介绍

OOM :  java.lang.OutOfMemoryError

**内存泄漏达到一定程度会引发OOM**。

当JVM因为没有足够的内存来为对象分配空间并且垃圾回收器也已经没有空间可回收时，就会抛出这个error



## 2、产生原因

1）分配的少了：比如虚拟机本身可使用的内存（一般通过启动时的VM参数指定）太少。

2）应用用的太多，并且用完没释放，浪费了。此时就会造成内存泄露或者内存溢出。

**内存泄露**：申请使用完的内存没有释放，导致虚拟机不能再次使用该内存，此时这段内存就泄露了，因为申请者不用了，而又不能被虚拟机分配给别人用。

**内存溢出**：申请的内存超出了JVM能提供的内存大小，此时称之为溢出。



## 3、Heap Dump 

Heap dump文件是一个二进制文件，它保存了某一时刻JVM堆中对象使用情况。Heap Dump文件是指定时刻的Java堆栈的快照，是一种镜像文件。Heap Dump一般都包含了一个堆中的Java Objects, Class等基本信息。同时，当你在执行一个转储操作时，往往会触发一次GC，所以你转储得到的文件里包含的信息通常是有效的内容（包含比较少，或没有垃圾对象了） 。我们可以这么理解：heap dump记录内存信息的，thread dump是记录CPU信息的。



## 4、分类

JVM里的**运行时数据区和直接内存**，除了程序计数器不会抛出OOM外，其他各个内存区域都可能会抛出OOM。

最常见的OOM情况有以下三种：

- java.lang.OutOfMemoryError: Java heap space ------>java堆内存溢出，此种情况最常见，一般由于内存泄露或者堆的大小设置不当引起。对于内存泄露，需要通过内存监控软件查找程序中的泄露代码，而堆大小可以通过虚拟机参数-Xms,-Xmx等修改。

- java.lang.OutOfMemoryError: PermGen space ------>java永久代溢出，即方法区溢出了，一般**出现于大量Class或者jsp页面，或者采用cglib等反射机制的情况**，因为上述情况会产生大量的Class信息存储于方法区。此种情况可以通过更改方法区的大小来解决，使用类似-XX:PermSize=64m -XX:MaxPermSize=256m的形式修改。另外，过多的常量尤其是字符串也会导致方法区溢出。

- java.lang.StackOverflowError ------> 不会抛OOM error，但也是比较常见的Java内存溢出。JAVA虚拟机栈溢出，一般是由于程序中存在死循环或者深度递归调用造成的，栈大小设置太小也会出现此种溢出。可以通过虚拟机参数-Xss来设置栈的大小。







# 二、OOM分析

JPS获取进程，Jstat获取虚拟机各种状态，Jmap获取dump文件，再用jhat分析文件，

要解决OOM异常，一般的手段就是：

## 1、获取dump

获取dump堆的内存镜像，可以采用如下两种方式：

- 设置JVM参数-XX:+HeapDumpOnOutOfMemoryError，设定当发生OOM时自动dump出堆信息。不过该方法需要JDK5以上版本。
- 使用JDK自带的**jmap命令**。"jmap -dump:format=b,file=heap.bin <pid>"  其中pid可以通过jps获取。

## 2、分析dump

采用内存映像分析工具如（MAT）对dump出来的堆转储快照进行分析，确认内存中的对象是否是必要的，查明到底是**内存泄露还是内存溢出**



- mat: eclipse memory analyzer, 基于eclipse RCP的内存分析工具。详细信息参见：http://www.eclipse.org/mat/，推荐使用。  
- jhat：JDK自带的java heap analyze tool，可以将堆中的对象以html的形式显示出来，包括对象的数量，大小等等，并支持对象查询语言OQL，分析相关的应用后，可以通过http://localhost:7000来访问分析结果。不推荐使用，因为在实际的排查过程中，一般是先在生产环境 dump出文件来，然后拉到自己的开发机器上分析，所以，不如采用高级的分析工具比如前面的mat来的高效。



## 3、解决

- 如果是内存泄露，可进一步通过工具查看泄露对象到GC Roots的引用链，准确定位到泄漏代码的位置； 
- 如果不存在泄漏的话，分析是堆内存溢出还是方法区溢出；
  -  如果是堆内存溢出，则适当调整堆的大小：通过-Xms或者-Xmx来进行设置；
  -  如果是方法区溢出，适当调整方法区的大小：通过-XX:Permsize；-XX：MaxPermSize设置永久代的大小；-XX：metaSpaceSize;-XX:MaxmetaSpace设置元空间的大小；





### 堆栈调优参数

| 参数              | 作用                                                         |
| ----------------- | ------------------------------------------------------------ |
| -Xms              | jvm启动时堆内存的初始大小                                    |
| -Xmx              | 堆内存的最大值                                               |
| -Xmn              | 新生代空间大小，剩下的为老年代空间大小                       |
| -Xss              | 栈空间大小                                                   |
| -XX:PermGen       | 设置永久代内存的初始化大小，jdk1.8开始废弃永久代             |
| -XX:MaxPermGen    | 设置永久代的最大值                                           |
| -XX:SUrvivorRatio | 设置新生代和存活区的比例。-XX:SurvivorRatio=8 表示存活区：新生代=1：8 =》新生代占年轻代的8/10,每个存活区各占年轻代的1/10。默认值：8 |
| -XX:NewRatio      | 设置老年代和年轻代的比例。比如：-XX:NewRatio=8 表示老年代内存:年轻代内存=8:1 => 老年代占堆内存的8/9;年轻代占堆内存的1/9。默认值：2 |





