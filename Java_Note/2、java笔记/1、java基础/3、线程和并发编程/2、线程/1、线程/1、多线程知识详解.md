

[TOC]



# 多线程知识详解

--------------------------------------------------------------------------------

## 一、基本定义

1、程序：是为完成特定任务，用某种语言编写的一组指令的集合，即指一段静态的代码，静态对象。

2、进程：是程序的一次执行过程，或是正在运行的一个程序，是一个动态的过程，竞争计算机系统资源的基本单位

3、线程：线程是比进程更小的执行单位，一个进程在其执行的过程中可以产生多个线程。与进程不同的是同类的多个线程共享进程的**堆**和**方法区**资源，但每个线程有自己的**程序计数器**、**虚拟机栈**和**本地方法栈**，所以系统在产生一个线程，或是在各个线程之间作切换工作时，负担要比进程小得多，也正因为如此，线程也被称为轻量级进程。

一个程序至少一个进程，一个进程至少一个线程。



4、并行：多个CPU同时执行多个任务，比如:多个人同时做不同的事

5、并发：一个CPU（采用时间片）同时执行多个任务，比如秒杀平台，多个人做同件事

6、多线程：

## 二、进程线程的区别
1、地址空间：同一进程的线程共享本进程的地址空间，而进程之间则是独立的地址空间。

2、资源拥有：同一进程内的线程共享本进程的资源，但是进程之间的资源是独立的。

3、一个进程崩溃后，在保护模式下不会对其他进程产生影响，但是一个线程崩溃整个进程都死掉。所以多进程要比多线程健壮。

4、进程切换时，消耗的资源大，效率高。所以涉及到频繁的切换时，使用线程要好于进程。同样如果要求同时进行并且又要共享某些变量的并发操作，只能用线程不能用进程。

5、执行过程：每个独立的进程程有一个程序运行的入口、顺序执行序列和程序入口。但是线程不能独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。

6、线程是处理器调度的基本单位，但是进程不是。

7、两者均可并发执行。

## 三、线程安全的实现
### 1、互斥同步
synchronized 和 ReentrantLock。

### 2、 非阻塞同步
- CAS
- 原子变量AtomicXXXX

### 3、无同步方案 
栈封闭，Thread Local，可重入代码



## 四、为什么使用多线程

先从总体上来说：

- **从计算机底层来说：** 线程可以比作是轻量级的进程，是程序执行的最小单位,线程间的切换和调度的成本远远小于进程。另外，多核 CPU 时代意味着多个线程可以同时运行，这减少了线程上下文切换的开销。
- **从当代互联网发展趋势来说：** 现在的系统动不动就要求百万级甚至千万级的并发量，而多线程并发编程正是开发高并发系统的基础，利用好多线程机制可以大大提高系统整体的并发能力以及性能。

再深入到计算机底层来探讨：

- **单核时代：** 在单核时代多线程主要是为了提高 CPU 和 IO 设备的综合利用率。举个例子：当只有一个线程的时候会导致 CPU 计算时，IO 设备空闲；进行 IO 操作时，CPU 空闲。我们可以简单地说这两者的利用率目前都是 50%左右。但是当有两个线程的时候就不一样了，当一个线程执行 CPU 计算时，另外一个线程可以进行 IO 操作，这样两个的利用率就可以在理想情况下达到 100%了。
- **多核时代:** 多核时代多线程主要是为了提高 CPU 利用率。举个例子：假如我们要计算一个复杂的任务，我们只用一个线程的话，CPU 只会一个 CPU 核心被利用到，而创建多个线程就可以让多个 CPU 核心被利用到，这样就提高了 CPU 的利用率。

## 五、多线程带来的问题

并发编程的目的就是为了能提高程序的执行效率提高程序运行速度，但是并发编程并不总是能提高程序运行速度的，而且并发编程可能会遇到很多问题，比如：内存泄漏、上下文切换、死锁还有受限于硬件和软件的资源闲置问题。