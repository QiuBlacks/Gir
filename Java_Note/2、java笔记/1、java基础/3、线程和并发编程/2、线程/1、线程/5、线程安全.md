[TOC]

# 线程安全

## 一、线程安全的体现

### 1、原子性（atomic,synchronized、ReentrantLock）

提供互斥访问，同一时刻只能有一个线程对数据进行操作；

JDK里面提供了很多atomic类，AtomicInteger,AtomicLong,AtomicBoolean等等。

它们是通过CAS完成原子性。



### 2、可见性（synchronized,volatile）

一个线程对主内存的修改可以及时地被其他线程看到；

volatile的可见性是通过内存屏障和禁止重排序实现的



### 3、有序性（happens-before原则、volatile、synchronized、lock）

在JMM中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。

一个线程观察其他线程中的指令执行顺序，由于指令重排序，该观察结果一般杂乱无序。



## 二、线程安全的实现

### 1、互斥同步

synchronized 和 ReentrantLock。

### 2、 非阻塞同步

- CAS
- 原子变量AtomicXXXX

### 3、无同步方案 

 **要保证线程安全，并不是一定就要进行同步**，两者没有因果关系。同步只是保证共享数据争用时的正确性的手段，如果一个方法本来就**不涉及共享数据**，那它自然就无需任何同步操作去保证正确性，因此会有一些代码天生就是线程安全的。

#### &emsp; 1）栈封闭

多个线程访问同一个方法的局部变量时，不会出现线程安全问题，因为局部变量存储在虚拟机栈中，属于线程私有的。


- JUC线程池: FutureTask详解
- JUC线程池: ThreadPoolExecutor详解
- JUC线程池: ScheduledThreadPool详解 
- JUC线程池: Fork/Join框架详解

#### &emsp; 2）Thread Local Storage(线程本地存储)

如果一段代码中所需要的数据必须与其他代码共享，那就看看这些共享数据的代码是否能保证在同一个线程中执行。如果能保证，我们就可以把共享数据的可见范围限制在同一个线程之内，这样，无须同步也能保证线程之间不出现数据争用的问题。

符合这种特点的应用并不少见，大部分使用消费队列的架构模式(如“生产者-消费者”模式)都会将产品的消费过程尽量在一个线程中消费完。其中最重要的一个应用实例就是经典 Web 交互模型中的“一个请求对应一个服务器线程”(Thread-per-Request)的处理方式，这种处理方式的广泛应用使得很多 Web 服务端应用都可以使用线程本地存储来解决线程安全问题。

可以使用 java.lang.ThreadLocal 类来实现线程本地存储功能



#### &emsp; 3）可重入代码

这种代码也叫做纯代码(Pure Code)，可以在代码执行的任何时刻中断它，转而去执行另外一段代码(包括递归调用它本身)，而在控制权返回后，原来的程序不会出现任何错误。

可重入代码有一些共同的特征，例如不依赖存储在堆上的数据和公用的系统资源、用到的状态量都由参数中传入、不调用非可重入的方法等。







## 三、线程安全等级

### 1. 不可变

不可变(Immutable)的对象一定是线程安全的，不需要再采取任何的线程安全保障措施。只要一个不可变的对象被正确地构建出来，永远也不会看到它在多个线程之中处于不一致的状态。 多线程环境下，应当尽量使对象成为不可变，来满足线程安全。 **不可变的类型:** 

- final 关键字修饰的基本数据类型 
- String 
- 枚举类型
- Number 部分子类，如 Long 和 Double 等数值包装类型，
  BigInteger 和 BigDecimal 等大数据类型。但同为 Number 的原子类 AtomicInteger 和 AtomicLong 则是可变的。

### 2. 绝对线程安全 

 不管运行时环境如何，调用者都不需要任何额外的同步措施。 

###  3. 相对线程安全

相对线程安全需要保证对这个对象单独的操作是线程安全的，在调用的时候不需要做额外的保障措施。但是对于一些特定顺序的连续调用，就可能需要在调用端使用额外的同步手段来保证调用的正确性。 

在 Java 语言中，大部分的线程安全类都属于这种类型，例如 Vector、HashTable、Collections 的 synchronizedCollection() 方法包装的集合等。


### 4. 线程兼容 

线程兼容是指对象本身并不是线程安全的，但是可以通过在调用端正确地使用同步手段来保证对象在并发环境中可以安全地使用，我们平常说一个类不是线程安全的，绝大多数时候指的是这一种情况。Java API 中大部分的类都是属于线程兼容的，如与前面的 Vector 和 HashTable 相对应的集合类 ArrayList 和 HashMap 等。

### 5. 线程对立

线程对立是指无论调用端是否采取了同步措施，都无法在多线程环境中并发使用的代码。由于 Java 语言天生就具备多线程特性，线程对立这种排斥多线程的代码是很少出现的，而且通常都是有害的，应当尽量避免







# 参考文章

[Java中如何保证线程安全性](https://blog.csdn.net/weixin_40459875/article/details/80290875)

[【多线程】如何保证线程安全](https://blog.csdn.net/qq_26545305/article/details/79516610)